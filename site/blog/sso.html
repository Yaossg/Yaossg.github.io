<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">SSO? SOS! | Yaossg&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yaossg.com/site/blog/sso"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="SSO? SOS! | Yaossg&#x27;s Site"><meta data-rh="true" name="description" content="这是我在编写编译器的过程中遇到的一个让人拍案叫绝的陷阱。特此记录下来。"><meta data-rh="true" property="og:description" content="这是我在编写编译器的过程中遇到的一个让人拍案叫绝的陷阱。特此记录下来。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-01-05T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="cpp"><link data-rh="true" rel="icon" href="/site/img/sausage.png"><link data-rh="true" rel="canonical" href="https://yaossg.com/site/blog/sso"><link data-rh="true" rel="alternate" href="https://yaossg.com/site/blog/sso" hreflang="en"><link data-rh="true" rel="alternate" href="https://yaossg.com/site/blog/sso" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://yaossg.com/site/blog/sso","mainEntityOfPage":"https://yaossg.com/site/blog/sso","url":"https://yaossg.com/site/blog/sso","headline":"SSO? SOS!","name":"SSO? SOS!","description":"这是我在编写编译器的过程中遇到的一个让人拍案叫绝的陷阱。特此记录下来。","datePublished":"2023-01-05T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://yaossg.com/site/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/site/blog/rss.xml" title="Yaossg&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/site/blog/atom.xml" title="Yaossg&#39;s Site Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/site/assets/css/styles.0c675859.css">
<script src="/site/assets/js/runtime~main.d6d898fd.js" defer="defer"></script>
<script src="/site/assets/js/main.4bee9a17.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/site/"><div class="navbar__logo"><img src="/site/img/sausage-128.png" alt="Yaossg&#x27;s Site" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/site/img/sausage-128.png" alt="Yaossg&#x27;s Site" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Yaossg&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/site/blog">Blog</a><a class="navbar__item navbar__link" href="/site/docs">Docs</a><a class="navbar__item navbar__link" href="/site/friends">Friends</a></div><div class="navbar__items navbar__items--right"><a href="https://space.bilibili.com/282144386" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/Yaossg/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">博客列表</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/pipeline">曲水流觞：上援下推</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/iterator">迭代器的接口对比</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/sad">秋</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/reg-alloc">定风波·分配寄存器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/never">never say never? ——简介现代类型系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/join">表连接算法概览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/ray-intersect">光线—三角形相交算法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/simd">&lt;experimental/simd&gt; 初体验</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/statistics">速通统计学</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/site/blog/sso">SSO? SOS!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/site/blog/analytic-geometry">高中圆锥曲线结论</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">SSO? SOS!</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-01-05T00:00:00.000Z">January 5, 2023</time> · <!-- -->8 min read</div></header><div id="__blog-post-container" class="markdown"><p>这是我在编写编译器的过程中遇到的一个让人拍案叫绝的陷阱。特此记录下来。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题">问题<a class="hash-link" aria-label="Direct link to 问题" title="Direct link to 问题" href="/site/blog/sso#问题">​</a></h2>
<p>假设你正在编写源代码处理系统。你设计了这样一个函数和类：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string_view</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">splitLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string_view view</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string_view</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">begin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">q</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token char">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> q </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Source</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> snippets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string_view</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snippets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">move</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">splitLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">snippets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了效率，你没有真的去分割字符串——而是利用 <code>string_view</code>，引用字符串中的一段作为一行，并把它们存入 <code>lines</code>。但是 <code>string_view</code> 并没有字符串的所有权，为了保证它引用的字符串不被回收，再使用 <code>snippets</code> 来保存这些字符串。如下图所示：</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="472" height="294" class="img_ev3q"></p>
<p>下面我们来试一试：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ab\ncd\nef&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>很好！</p>
<p>可是，当我们试图多次调用 append 的时候</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>大跌眼镜的事情发生了：输出了一团乱码！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="思考">思考<a class="hash-link" aria-label="Direct link to 思考" title="Direct link to 思考" href="/site/blog/sso#思考">​</a></h2>
<p>输出乱码原因有哪些呢？你肯定已经想到了以下两种可能：</p>
<ul>
<li><code>string</code> 管理的 <code>char[]</code> 被覆写或被释放了</li>
<li><code>string_view</code> 被修改了</li>
</ul>
<p>先来测一下第一种可能</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> snippet </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">snippets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> snippet </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">line 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看上去字符串完好无损。</p>
<p>再来测测第二种可能</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;line 3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x26a40fc18e0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x26a40fc18e0 0x26a40fc1c90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x26a40fc18e0 0x26a40fc1c90 0x26a40fc1d00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>string_view</code> 也没有变化！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="规律">规律<a class="hash-link" aria-label="Direct link to 规律" title="Direct link to 规律" href="/site/blog/sso#规律">​</a></h2>
<p>你可能百思不得其解。先别急，我们再来做一个实验。</p>
<p>之前我们就发现，如果只 <code>append</code> 一次是没问题的。那么不妨测试一下乱码与 <code>append</code> 次数有没有什么关系。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;OOO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;OOO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;***&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** *** *** *** *** OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** *** *** *** *** *** *** *** OOO OOO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这太有规律了！每次 <code>append</code> 乱码的 <code>string_view</code> 数量要么保持不变，要么就翻一倍，这似乎暗合了某个容器的某个特性。是的，<code>vector</code>。于是我们对前面的 <code>Source</code> 作出一点修改：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct Source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   std::vector&lt;std::string&gt; snippets;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   std::deque&lt;std::string&gt; snippets;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>再执行上面的代码，输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO OOO OOO OOO OOO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOO OOO OOO OOO OOO OOO OOO OOO OOO OOO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>修复了！太棒了！</p>
<p>但，这应该不是 <code>vector</code> 的问题吧？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="第三  种可能">第三种可能<a class="hash-link" aria-label="Direct link to 第三种可能" title="Direct link to 第三种可能" href="/site/blog/sso#第三种可能">​</a></h2>
<p><code>vector</code> 在 <code>size &gt; capacity</code> 的时候，会重新分配两倍的空间，并把原来的元素全部移动过去。但是移动的是 <code>string</code>，它管理的 <code>char[]</code> 难道也跟着发生了移动吗？还是说，发生的不是移动，而是复制？</p>
<p>带着这个疑问，我们再做一个实验：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Observer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Observer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; make &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Observer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Observer</span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> other</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">noexcept</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">other</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; move &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Observer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Observer</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> other</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">other</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; copy &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Observer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> observers</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line 1: &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    observers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line 2: &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    observers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line 3: &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    observers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line 4: &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    observers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">line 1:  make 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line 2:  make 2 move 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line 3:  make 3 move 1 move 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line 4:  make 4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要注意的是，<code>Observer</code> 移动构造器的 <code>noexcept</code> 是不可以省略的，否则它会优先选择复制构造器而不是可能抛出异常的移动构造器。</p>
<p>经过查询，我们可以确认 <code>string</code> 的移动构造器是 <code>noexcept</code> 的。可见发生的是移动而不是复制。</p>
<p>也就是说：我们移动了 <code>string</code>，而它管理的 <code>char[]</code> 也跟着移动了！为什么？</p>
<p>在引出今天的主角之前，我们再测试一个例子。<code>Source</code> 回退到未修复的版本，运行下面的代码：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source source</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;a very long line 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;a very long line 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;a very long line 3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> line </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">a very long line 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a very long line 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a very long line 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>问题奇迹般的消失了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sso">SSO<a class="hash-link" aria-label="Direct link to SSO" title="Direct link to SSO" href="/site/blog/sso#sso">​</a></h2>
<p>没错，这一切的罪魁祸首便是：短字符串优化（Short String Optimization，SSO）。</p>
<p>这是一种常见的字符串实现，被大部分的标准库（如 GCC libstdc++、Clang libc++、MSVC STL 等）采用。当字符串比较长的时候，字符串会被存在别处，并用 <code>string</code> 对象中的指针引用，如我们预料的一样；当字符串比较短的时候，字符串将直接存在 <code>string</code> 对象内部！</p>
<p>例如 libstdc++ 的实现如下图所示：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string s1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line 1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string s2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a very long line 1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="771" height="200" class="img_ev3q"></p>
<p>在这个实现中，短字符串优化的阈值是 15。末尾多余的一个字符用来存 0，来保证它同时是一个 C-Style String。此时 <code>capacity()</code> 永远返回 15。</p>
<p>综上所述，当字符串较短的时候，由它构造的 <code>string_view</code> 实际上是指向 <code>string</code> 自己（的一部分）的！那么当 <code>string</code> 本身被移走，它所在的位置被释放，<code>string_view</code> 自然而然就引用了一段非法的内存。<code>deque</code> 在插入新元素的时候不会移动旧元素，因此避免了这个问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后记">后记<a class="hash-link" aria-label="Direct link to 后记" title="Direct link to 后记" href="/site/blog/sso#后记">​</a></h2>
<p>我实际上很早就了解过 SSO，但是实在没料到会以这样的形式遭遇，过程曲折离奇，叹为观止。只能说如果没有这个前置知识我可能还得埋头苦苦寻找原因很长时间。</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/site/blog/tags/cpp">cpp</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/site/blog/statistics"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">速通统计学</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/site/blog/analytic-geometry"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">高中圆锥曲线结论</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#问题">问题</a></li><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#思考">思考</a></li><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#规律">规律</a></li><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#第三种可能">第三种可能</a></li><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#sso">SSO</a></li><li><a class="table-of-contents__link toc-highlight" href="/site/blog/sso#后记">后记</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Quick Access</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Yaossg/site" target="_blank" rel="noopener noreferrer" class="footer__link-item">Site Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Related Sites</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://yaossg.com/end-poem/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Online End Poem<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Yaossg's Site</div></div></div></footer></div>
</body>
</html>